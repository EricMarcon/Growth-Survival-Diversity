---
title: "Growth, Survival, Diversity and Concentration"
author:
  - name: "Eric Marcon"
  - name: "Florence Puech"
abstract: >
  Exploratory model of growth and survival depending on Diversity and concentration.
date: "`r format(Sys.time(), '%d %B %Y')`"
url: https://EricMarcon.github.io/Growth-Survival-Diversity/
github-repo: EricMarcon/Growth-Survival-Diversity
# Language
lang: en-US
# Bibliography
bibliography: references.bib
biblio-style: chicago
# LaTeX
# Print table of contents in PDFs?
pdftoc: false
# If true, choose its depth
toc-depth: 3
# URL color
urlcolor: blue
# Do not modify
always_allow_html: yes
csquotes: true
output:
  rmdformats::downcute:
    use_bookdown: yes
    lightbox: yes
  bookdown::pdf_book:
    template: latex/template.tex
    citation_package: natbib
    latex_engine: xelatex
    keep_tex: yes
---

```{r DoNotModify, include=FALSE}
### Utilities. Do not modify.
# Installation of packages if necessary
InstallPackages <- function(Packages) {
  InstallPackage <- function(Package) {
    if (!Package %in% installed.packages()[, 1]) {
      install.packages(Package, repos="https://cran.rstudio.com/")
    }
  }
  invisible(sapply(Packages, InstallPackage))
}

# Basic packages
InstallPackages(c("bookdown", "formatR", "ragg"))

# Chunk font size hook: allows size='small' or any valid Latex font size in chunk options
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
```

```{r Options, include=FALSE}
### Customized options for this document
# Add necessary packages here
Packages <- c("tidyverse", "remotes", "spatstat", "dbmss")
# Install them
InstallPackages(Packages)
# From GitHub
remotes::install_github("EricMarcon/SpatDiv")

# knitr options
knitr::opts_chunk$set(
  cache =   FALSE,    # Cache chunk results
  include = TRUE,     # Show/Hide chunks
  echo =    TRUE,     # Show/Hide code
  warning = FALSE,    # Show/Hide warnings
  message = FALSE,    # Show/Hide messages
  # Figure alignment and size
  fig.align = 'center', out.width = '80%',
  # Graphic devices (ragg_png is better than standard png)
  dev = c("ragg_png", "pdf"),
  # Code chunk format
  tidy = TRUE, tidy.opts = list(blank=FALSE, width.cutoff=50),
  size = "scriptsize", knitr.graphics.auto_pdf = TRUE
  )
options(width = 50)

# ggplot style
library("tidyverse")
theme_set(theme_bw())
theme_update(panel.background=element_rect(fill="transparent", colour=NA),
             plot.background=element_rect(fill="transparent", colour=NA))
knitr::opts_chunk$set(dev.args=list(bg="transparent"))

# Random seed
set.seed(973)
```


# Purpose

This exploratory study is a proof of concept for modeling plant growth and survival with respect to relative concentration and diversity.

A set of plants is simulated in a square area with R [@R].
Each plant belongs to an economic sector and has a size.
Each sector is drawn separately.
Location is generated according to a classical point process, and plant sizes according to a random distribution.

The growth model follows @Audretsch2007.
Exogenous variables are the plant environment, summarized here by its X coordinate: a positive gradient of growth conditions exists from west to east.
The local geographic concentration of the sector around each plant [@Lang2014] and the local diversity [@Marcon2014a] of sectors in the neighborhood of each plant are the variables of interest.

# Data generation

## Point set

Plants are simulated in a square window by the *Spatdiv* package.

```{r}
library("SpatDiv")
# Geometry of the window
window_size <- 2000 # Small during development
unit_name <- c("meter", "meters")
# Density
plants_n_per_area <- 100/1E6
# Number of sectors
sectors_n <- 5
# Spatial concentration of plants
thomas_scale <- window_size/3
thomas_mu <- 100
```

The community is simulated:

```{r}
library("spatstat")
rSpCommunity(
  n = 1, 
  size = window_size^2 * plants_n_per_area, 
  S = sectors_n, 
  Spatial = "Thomas", scale = thomas_scale, mu = thomas_mu,
  Sizes = "Weibull",
  win = square(r = window_size, unitname = unit_name)
) -> spCommunity
# Number of plants
spCommunity$n
# Per sector
summary(spCommunity$marks$PointType)
# Sizes
hist(spCommunity$marks$PointWeight)
# Map
autoplot(spCommunity)
```

## Parameters

```{r}
# Number of simulations to compute confindence envelopes
n_simulations <- 10 # Small during development
```


# Diversity

Accumulation.

```{r}
# Average distance between plants
dist_neighbor <- 1 / sqrt(plants_n_per_area)
# Accumulation of diversity with confidence interval (not run)
accum <- DivAccum(
  spCommunity,
  r.seq = c(
    0,
    seq(
      from = dist_neighbor / 4,
      to = dist_neighbor * 4,
      by = dist_neighbor / 4
    )
  ),
  q.seq = 0:2,
  H0 = "RandomLocation",
  NumberOfSimulations = n_simulations,
  Individual = TRUE
)
autoplot(accum)
# Map the local diversity (richness at 4 x dist to neighbor)
MapPlot(accum, Order = 0, NeighborHood = dist_neighbor * 4)
# Diversity at 4 times the average distance to neighbor 
accum_5 <- DivAccum(
  spCommunity, 
  r.seq = c(0, dist_neighbor * 4),
  q.seq = 0:2, 
  Individual = TRUE
)
# Extract the data [order, distance, points]
div_plants <- accum_5$Neighborhoods[1, 2, ]
# Distribution of richness
hist(div_plants)
```

# Concentration

Spatial concentration of sectors.

```{r}
# Compute individual M
library("dbmss")
# Compute concentration of each sector
M_plants <- numeric(spCommunity$n)
for (sector in levels(spCommunity$marks$PointType)) {
  M_sector <- Mhat(
    spCommunity, 
    r = c(0, window_size /10),
    ReferenceType = sector, 
    Individual = TRUE
  )
  point_numbers <- as.integer(substring(names(M_sector)[-(1:3)], 3))
  M_plants[point_numbers] <- as.numeric(as.data.frame(M_sector)[2, -(1:3)])
}
hist(M_plants)
```
# Correlation

Check the absence of correlation between concentration and diversity.

```{r}
cor(M_plants, div_plants)
```


# Growth model

The model defines growth as $\ln({Size_{i,t+1}}) = \ln(Size_{i,t}) + \alpha x + \beta Conc_{i,t} + \gamma Div_{i,t} + \epsilon_{i,t}$.

## Parameters

```{r}
alpha <- 1 / max(spCommunity$x)
conc <- scale(log(M_plants+1))
beta <- 1 / max(conc)
div <- scale(div_plants)
gamma <- 1 / max(div)
epsilon <- rnorm(spCommunity$n, 0, .5)
```

## Simulation

Simulate growth.

```{r}
growth <- alpha  * spCommunity$x + beta * conc + gamma * div + epsilon
hist(growth)
size_t1 <- spCommunity$marks$PointWeight * exp(growth)
```

## Inference

Check that parameters can be inferered from the data.

```{r}
growth_obs <- log(size_t1 / spCommunity$marks$PointWeight)
lm_plants <- lm(growth_obs ~ spCommunity$x + conc + div)
summary(lm_plants)

```




`r if (!knitr:::is_latex_output()) '# References {-}'`
